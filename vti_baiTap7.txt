#Question 1: Tạo trigger không cho phép người dùng nhập vào Group có ngày tạo trước 1 năm trước
drop trigger if exists trigger_check_group_create_date;
delimiter $$
create trigger trigger_check_group_create_date
before insert on `groups`
for each row
begin
IF TIMESTAMPDIFF(YEAR, NEW.create_date, CURRENT_DATE()) >= 1 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Ngày tạo group không được trước 1 năm!';
        end if ;
end $$
delimiter ;  

#Question 2: Tạo trigger Không cho phép người dùng thêm bất kỳ user nào vào
#department "Sale" nữa, khi thêm thì hiện ra thông báo "Department
#"Sale" cannot add more user"
	drop trigger if exists trigger_stop_add_user;
	delimiter $$
	create trigger trigger_stop_add_user
	before insert on department
	for each row
	begin
	IF (select department_name from department where department_id = new.department_id ) = 'Sale' THEN
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'Department "Sale" cannot add more user';
			end if ;
	end $$
	delimiter ;  

#Question 3: Cấu hình 1 group có nhiều nhất là 5 user
drop trigger if exists trigger_limit_group_user;
delimiter $$
create trigger trigger_limit_group_user
before insert on group_account
for each row
begin
IF (select count(account_id) from group_account where group_id = new.group_id  )>=5 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = 'max user reached';
		end if ;
end $$
delimiter ;  

#Question 4: Cấu hình 1 bài thi có nhiều nhất là 10 Question
drop trigger if exists trigger_limit_exam_question;
delimiter $$
create trigger trigger_limit_exam_question
before insert on exam_question 
for each row
begin
IF (select count(question_id) from exam_question where exam_id = new.exam_id  )>=10 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = 'max question reached';
		end if ;
end $$
delimiter ;  

#Question 5: Tạo trigger không cho phép người dùng xóa tài khoản có email là
#admin@gmail.com (đây là tài khoản admin, không cho phép user xóa),
#còn lại các tài khoản khác thì sẽ cho phép xóa và sẽ xóa tất cả các thông
#tin liên quan tới user đó
drop trigger if exists trigger_not_allow_delete_admin_account;
delimiter $$
create trigger trigger_not_allow_delete_admin_account
before delete on accounts 
for each row
begin
IF old.email = 'admin@gmail.com' THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = 'cant delete admin account';
        else
        DELETE FROM group_account WHERE account_id = OLD.account_id;
		end if ;
end $$
delimiter ;  

#Question 6: Không sử dụng cấu hình default cho field DepartmentID của table
#Account, hãy tạo trigger cho phép người dùng khi tạo account không điền
#vào departmentID thì sẽ được phân vào phòng ban "waiting Department"
drop trigger if exists trigger_autofill_department_id;
delimiter $$
create trigger trigger_autofill_department_id
before insert on accounts 
for each row
begin
IF new.department_id is null THEN
set new.department_id = 7;
		end if ;
end $$
delimiter ;  

#Question 7: Cấu hình 1 bài thi chỉ cho phép user tạo tối đa 4 answers cho mỗi
#question, trong đó có tối đa 2 đáp án đúng.

drop trigger if exists trigger_limit_answer_for_question;
delimiter $$
create trigger trigger_limit_answer_for_question
before insert on answer
for each row
begin
IF (select count(answer_id) from answer where question_id = new.question_id)>=4 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = 'max answer reach';
        end if ;
if (new.is_correct =1 and (select count(answer_id) from answer where question_id = new.question_id and is_correct = 1)>=2) 
then
SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = 'max correct answer reach';
		end if ;
end $$
delimiter ; 

#Question 8: Viết trigger sửa lại dữ liệu cho đúng:
#Nếu người dùng nhập vào gender của account là nam, nữ, chưa xác định
#Thì sẽ đổi lại thành M, F, U cho giống với cấu hình ở database
drop trigger if exists trigger_gender;
delimiter $$
create trigger trigger_gender
before insert on accounts
for each row
begin
IF new.gender = 'nam'  THEN
		set new.gender = 'M';
        end if ;
IF new.gender = 'nữ'  THEN
		set new.gender = 'F';
        end if ;
IF new.gender = 'chưa xác định'  THEN
		set new.gender = 'U';
        end if ;
end $$
delimiter ; 

#Question 9: Viết trigger không cho phép người dùng xóa bài thi mới tạo được 2 ngày
drop trigger if exists trigger_no_delete_2ds_exam;
delimiter $$
create trigger trigger_no_delete_2ds_exam
before delete on exam
for each row
begin
IF TIMESTAMPDIFF(DAY, old.create_date, CURRENT_DATE()) <= 2 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = 'cant delete exam under 2 days old';
		end if ;
end $$
delimiter ;  

#Question 10: Viết trigger chỉ cho phép người dùng chỉ được update, delete các
#question khi question đó chưa nằm trong exam nào
drop trigger if exists trigger_no_delete_question_in_exam;
delimiter $$
create trigger trigger_no_delete_question_in_exam
before delete on question 
for each row
begin
IF (select count(exam_id) from exam_question where question_id = old.uestion_id) != 0 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = 'question already in exam';
		end if ;
end $$
delimiter ;  

drop trigger if exists trigger_no_delete_question_in_exam;
delimiter $$
create trigger trigger_no_delete_question_in_exam
before update on question 
for each row
begin
IF (SELECT 
    COUNT(exam_id)
FROM
    exam_question
WHERE
    question_id = old.uestion_id) != 0 THEN
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = 'question already in exam';
		end if ;
end $$
delimiter ;  

#Question 12: Lấy ra thông tin exam trong đó:
#Duration <= 30 thì sẽ đổi thành giá trị "Short time"
#30 < Duration <= 60 thì sẽ đổi thành giá trị "Medium time"
#Duration > 60 thì sẽ đổi thành giá trị "Long time"
SELECT 
    exam_id,
    title,
    duration,
    CASE 
        WHEN duration <= 30 THEN 'Short time'
        WHEN duration > 30 AND duration <= 60 THEN 'Medium time'
        ELSE 'Long time'
    END AS duration_type
FROM exam

#Question 13: Thống kê số account trong mỗi group và in ra thêm 1 column nữa có tên
#là the_number_user_amount và mang giá trị được quy định như sau:
#Nếu số lượng user trong group =< 5 thì sẽ có giá trị là few
#Nếu số lượng user trong group <= 20 và > 5 thì sẽ có giá trị là normal
#Nếu số lượng user trong group > 20 thì sẽ có giá trị là higher
SELECT 
    ga.group_id,
    COUNT(ga.account_id) AS number_of_accounts,
    CASE
        WHEN COUNT(ga.account_id) <= 5 THEN 'few'
        WHEN
            COUNT(ga.account_id) > 5
                AND COUNT(ga.account_id) <= 20
        THEN
            'normal'
        ELSE 'higher'
    END AS the_number_user_amount
FROM
    group_account ga
GROUP BY ga.group_id;

#Question 14: Thống kê số mỗi phòng ban có bao nhiêu user, nếu phòng ban nào
#không có user thì sẽ thay đổi giá trị 0 thành "Không có User"
SELECT 
    d.department_name,
    CASE
        WHEN COUNT(a.account_id) = 0 THEN 'Không có User'
        ELSE COUNT(a.account_id)
    END AS number_of_user
FROM
    accounts a
        LEFT JOIN
    department d ON a.department_id = d.department_id
GROUP BY d.department_id